# Exchange JSON Manager Script

## –Ø–∑—ã–∫–∏ / Languages
- [üá∑üá∫ –†—É—Å—Å–∫–∏–π](README.ru.md) ‚Üê (–¢–µ–∫—É—â–∏–π)
- [üá∫üá∏ English](README.md)

PowerShell —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö Exchange Server —á–µ—Ä–µ–∑ Zabbix —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ.

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö Exchange Server –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Zabbix. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä Exchange.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ –ø–∞–ø–∫—É:
   ```
   C:\Scripts\db\exchange_json_manager.ps1
   ```

2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏, –æ—Ç –∫–æ—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç, –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞:
   - –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Exchange
   - –°–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ `C:\Scripts\db\`

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

- `Action` - –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: "discovery")
- `DatabaseName` - –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π)
- `CacheLifetime` - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 30)

## –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### discovery
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –¥–ª—è Zabbix Low Level Discovery —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—Å–µ—Ö –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö.

```powershell
.\exchange_json_manager.ps1 -Action discovery
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```json
{"data":[{"{#DBNAME}":"DB01","{#DBSERVER}":"EXCH01"},{"{#DBNAME}":"DB02","{#DBSERVER}":"EXCH01"}]}
```

### mounted
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

```powershell
.\exchange_json_manager.ps1 -Action mounted -DatabaseName "DB01"
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `1` - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
- `0` - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

### size
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö.

```powershell
.\exchange_json_manager.ps1 -Action size -DatabaseName "DB01"
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: `5368709120`)

### status
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö.

```powershell
.\exchange_json_manager.ps1 -Action status
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: `3`)

### lastupdate
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –º–∏–Ω—É—Ç–∞—Ö.

```powershell
.\exchange_json_manager.ps1 -Action lastupdate
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** 
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- `9999` - –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

### fileage
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç JSON —Ñ–∞–π–ª–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö.

```powershell
.\exchange_json_manager.ps1 -Action fileage
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –≤–æ–∑—Ä–∞—Å—Ç —Ñ–∞–π–ª–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
- `9999` - –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

### forceupdate
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ Exchange.

```powershell
.\exchange_json_manager.ps1 -Action forceupdate
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `1` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
- `0` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ—É—Å–ø–µ—à–Ω–æ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON —Ñ–∞–π–ª–∞

–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª `C:\Scripts\db\databases_info.json` —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```json
{
  "LastUpdate": "2024-01-15 14:30:00",
  "LastUpdateUnix": 1705316200,
  "DatabaseCount": 2,
  "Databases": [
    {
      "Name": "DB01",
      "Server": {
        "Name": "EXCH01"
      },
      "Mounted": true,
      "MountedNumeric": 1,
      "DatabaseSize": "5.0 GB (5,368,709,120 bytes)",
      "DatabaseSizeBytes": 5368709120
    }
  ]
}
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Zabbix

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

–î–æ–±–∞–≤—å—Ç–µ –≤ `zabbix_agentd.conf`:

```ini
# Exchange Database Discovery
UserParameter=exchange.db.discovery,powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\Scripts\db\exchange_json_manager.ps1" -Action discovery

# Exchange Database Status
UserParameter=exchange.db.mounted[*],powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\Scripts\db\exchange_json_manager.ps1" -Action mounted -DatabaseName "$1"

# Exchange Database Size
UserParameter=exchange.db.size[*],powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\Scripts\db\exchange_json_manager.ps1" -Action size -DatabaseName "$1"

# Exchange General Status
UserParameter=exchange.db.status,powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\Scripts\db\exchange_json_manager.ps1" -Action status

# Exchange Cache Age
UserParameter=exchange.cache.age,powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\Scripts\db\exchange_json_manager.ps1" -Action lastupdate
```

### –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ Zabbix

1. **Discovery Rule:**
   - Key: `exchange.db.discovery`
   - Update interval: 1h

2. **Item prototypes:**
   - Mounted Status: `exchange.db.mounted[{#DBNAME}]`
   - Database Size: `exchange.db.size[{#DBNAME}]`

3. **Trigger prototypes:**
   - Database unmounted: `{Template:exchange.db.mounted[{#DBNAME}].last()}=0`
   - Database size critical: `{Template:exchange.db.size[{#DBNAME}].last()}>50000000000`

## –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:

- **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞:** 30 –º–∏–Ω—É—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `CacheLifetime`)
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç lock-—Ñ–∞–π–ª
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫–µ—à–∞

## –§–∞–π–ª—ã

- `C:\Scripts\db\exchange_json_manager.ps1` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
- `C:\Scripts\db\databases_info.json` - –∫–µ—à –¥–∞–Ω–Ω—ã—Ö
- `C:\Scripts\db\update.lock` - —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–≤—Ä–µ–º–µ–Ω–Ω—ã–π)

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞

```powershell
# –ü—Ä–æ–≤–µ—Ä–∫–∞ discovery
.\exchange_json_manager.ps1 -Action discovery

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ë–î
.\exchange_json_manager.ps1 -Action mounted -DatabaseName "DB01"

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
.\exchange_json_manager.ps1 -Action forceupdate
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ Exchange:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Exchange

2. **–§–∞–π–ª –∫–µ—à–∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É `C:\Scripts\db\`

3. **–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `forceupdate` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å:** –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 5-10 —Å–µ–∫—É–Ω–¥ (—Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å Exchange)
- **–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:** –º–µ–Ω–µ–µ 1 —Å–µ–∫—É–Ω–¥—ã (—á—Ç–µ–Ω–∏–µ –∏–∑ –∫–µ—à–∞)
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ Zabbix:** 5-10 –º–∏–Ω—É—Ç

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –°–∫—Ä–∏–ø—Ç –Ω–µ –≤—ã–≤–æ–¥–∏—Ç –æ—à–∏–±–∫–∏ –≤ stdout (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Zabbix)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Exchange
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç lock-—Ñ–∞–π–ª—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## –õ–∏—Ü–µ–Ω–∑–∏—è

–°–∫—Ä–∏–ø—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥–µ.

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã.